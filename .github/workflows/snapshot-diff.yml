name: "Snapshot Tests: Vue Components"

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  snapshot-test:
    name: Vue Snapshot Tests ðŸ“·
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [21.3.0]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: "yarn"

      - name: Install dependencies and build
        run: |
          yarn install --immutable
          yarn ci:build

      - name: Prepare Nuxt for tests
        run: yarn prepare

      - name: Run Snapshot Tests
        run: yarn test:snapshot > snapshot-output.txt 2>&1

      - name: Upload snapshot-output.txt as artifact
        uses: actions/upload-artifact@v4
        with:
          name: snapshot-output
          path: snapshot-output.txt

      - name: Comment PR with snapshot result
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('snapshot-output.txt', 'utf8');
            const relevantLines = output
              .split('\n')
              .filter(line => 
                line.includes('expect(received).toMatchSnapshot') ||
                line.includes('Snapshot name:')
              );
            let body = '';

            if (relevantLines.length > 0) {
              body = `ðŸ§ª **Snapshot Changed**\n\n\`\`\`\n${relevantLines.join('\n').slice(0, 6500)}\n\`\`\`\n\nIf these changes are expected, run \`yarn test:snapshot:update\`.`;
            } else {
              body = `âœ… **Snapshot Test Passed** â€” Nothing in the UI changed.`;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });