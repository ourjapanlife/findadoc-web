name: Lint Locales

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '45 15 * * 4'

permissions:
  contents: read
  pull-requests: write

jobs:
  locale-lint:
    name: Linting Locales ðŸ˜Ž
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [21.3.0]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install Node.js and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "yarn"
      - name: Install Dependencies
        run: yarn install --immutable
      - name: Run Locales Lint
        id: lint
        run: |
          NODE_ENV=production node i18n/checkLocaleKeys.js --report-only > missing_keys.txt
          if [ -s missing_keys.txt ]; then
            cat missing_keys.txt
            exit 1
          fi
      - name: Create Comment with Fix Button
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const missingKeys = fs.readFileSync('missing_keys.txt', 'utf8').trim().split('\n');
            const formattedKeys = missingKeys.map(key => `- ${key}`).join('\n');
          
            // Construct the URL for the workflow dispatch
            const repo = '${{ github.repository }}';
            const branch = '${{ github.ref }}'.replace('refs/heads/', '');
            const workflowUrl = `https://api.github.com/repos/${repo}/actions/workflows/trigger-fix-locales.yml/dispatches`;
          
            // Create the comment body with the workflow dispatch URL
            const commentBody = `### Missing Locale Keys Found:\n${formattedKeys}\n\n[![Fix Missing Keys](https://img.shields.io/badge/-Fix%20Missing%20Keys-blue?style=for-the-badge&logo=github)](${workflowUrl}?ref=${branch})`;
          
            // Create the comment on the issue
            github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: commentBody
            });