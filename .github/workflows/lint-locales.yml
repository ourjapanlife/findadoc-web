name: Lint Locales

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '45 15 * * 4'

permissions:
  contents: read
  pull-requests: write
  actions: write  # Ensure actions permissions are set to write

jobs:
  locale-lint:
    name: Linting Locales ðŸ˜Ž
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [21.3.0]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node.js and Yarn
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'yarn'

      - name: Install Dependencies
        run: yarn install --immutable

      - name: Run Locales Lint
        id: lint
        run: |
          NODE_ENV=production node i18n/checkLocaleKeys.js --report-only > missing_keys.txt
          if [ -s missing_keys.txt ]; then
            cat missing_keys.txt
            exit 1
          fi

      - name: Create Comment with Fix Button
        if: failure()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read missing keys from the file
            const missingKeysContent = fs.readFileSync('missing_keys.txt', 'utf8').trim();
            const missingKeys = missingKeysContent ? missingKeysContent.split('\n') : [];

            if (missingKeys.length === 0) {
              console.log('No missing keys found.');
              return;
            }

            const formattedKeys = missingKeys.map(key => `- ${key}`).join('\n');

            const repo = context.repo.repo;
            const owner = context.repo.owner;
            const workflowId = 'fix-locales-keys.yml'; // Adjust to match your target workflow file name
            const eventType = 'button_clicked'; // Custom event type
            const ref = process.env.GITHUB_REF_NAME || 'main';

            // Generate the link to trigger the repository_dispatch event
            const fixButtonMarkdown = `[![Fix Missing Keys](https://img.shields.io/badge/-Fix%20Missing%20Keys-blue?style=for-the-badge&logo=github)](https://github.com/${owner}/${repo}/actions/workflows/${workflowId}/dispatches?ref=${ref}&event_type=${eventType})`;

            const commentBody = `### Missing Locale Keys Found: ${formattedKeys}\n\n${fixButtonMarkdown}\n\nTo fix the missing keys, click the button above or run the following command in your terminal:\n\`\`\`bash\nyarn lint:locales\n\`\`\``;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner,
              repo,
              body: commentBody
            });
